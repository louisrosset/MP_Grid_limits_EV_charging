---
title: "06_analysis_housing"
output: html_document
---

This file analyzes the relationships between housing characteristics and other demographic data

```{r}
library(Hmisc)
library(fANCOVA)
library(boot)
library(reshape2)
library(tictoc)
library(tidyverse)
library(colorspace)
library(gridExtra)
library(cowplot)
```

```{r}
#Extract SCE and PG&E ICA access data
setwd('C:/Users/Louis Rosset/Documents/EPFL/Master Project/Grid_limits_EV_charging/04_allocation/IOUdata')

SCEtypes <- read.csv("SCE/circuitfiles/SCE_ICAalldemoallocclasses.csv", header = TRUE, na.strings = "?")
SCE_ICAalldemo <- read.csv("SCE/circuitfiles/SCE_ICAalldemoalloc.csv", header = TRUE, na.strings = "?", colClasses = as.character(SCEtypes$x))

PGEtypes <- read.csv("PGE/circuitfiles/PGE_ICAalldemoallocclasses.csv", header = TRUE, na.strings = "?")
PGE_ICAalldemo <- read.csv("PGE/circuitfiles/PGE_ICAalldemoalloc.csv", header = TRUE, na.strings = "?", colClasses = as.character(PGEtypes$x))

rm(PGEtypes, SCEtypes)
```

```{r}
cols = c("GEOID","CircuitName","IOU","tothh_Cpoly", "singleunit_pct",
         "MUD_pct", "duplex_pct", "smallmulti_pct", "largemulti_pct")
```

Setting up dataframe to define plotting parameters for demographic variable plots

```{r}
featscales <- data.frame(feature=c("racediversity", "black_pct", "asian_pct", "nlxwhite_pct", "latinx_pct"),
                               f_min=c(0,0,0,0,0), f_max=c(1,1,1,1,1), f_cap=c(1,1,1,1,1), f_binwidth=c(.05,.05,.05,.05,.05), 
                               f_div=c(.01,.01,.01,.01,.01), y_liml=c(0,-4,-2,0,0), y_limh=c(8,10,10,12.5,10),
                               f_xlab=c("Racial and ethnic diversity in the population (1: more diverse)", 
                                        "Population identifying as Black (%)", "Population identifying as Asian (%)",
                                        "Population identifying as non-Latinx white (%)", "Population identifying as Latinx (%)"),
                               f_cat=c("demo_race_","demo_race_","demo_race_","demo_race_","demo_race_"))

featscales <- rbind(featscales,
                    data.frame(feature=c("inc50kbelow_pct", "inc150kplus_pct", "medhhinc"),
                               f_min=c(0,0,0), f_max=c(1,1,250000), f_cap=c(1,1,250000),
                               f_binwidth=c(0.05,0.05,10000), f_div=c(.01,.01,1000), y_liml=c(0,0,0), y_limh=c(12,15,12),
                               f_xlab=c("Households earning $50k or less annually (%)", "Households earning $150k or more annually (%)",
                                        "Median household income ($1000)"), f_cat=c("demo_inc_","demo_inc_","demo_inc_")))

featscales <- rbind(featscales,
                    data.frame(feature=c("ownerocc_pct","medyrbuilt"),
                               f_min=c(0,1938), f_max=c(1,2012), f_cap=c(1,2012),
                               f_binwidth=c(0.05,2), f_div=c(.01,1), y_liml=c(0,0), y_limh=c(12,30),
                               f_xlab=c("Owner-occupied households (%)", "Median year built"), 
                               f_cat=c("demo_hs_","demo_hs_")))

featscales <- rbind(featscales,
                    data.frame(feature=c("tothh","edavgyrs","hhdensity_hhsqkm"),
                               f_min=c(0,0,0), f_max=c(4600,20,44000), f_cap=c(4000,20,10000),
                               f_binwidth=c(200,1,250), f_div=c(1,1,1000), y_liml=c(0,0,-1), y_limh=c(35,40,10),
                               f_xlab=c("Households in block group", "Average years of education",
                                        "Household density (thousand households per sq.km.)"), f_cat=c("demo_","demo_","demo_")))

featscales <- rbind(featscales,
                     data.frame(feature=c("polexposure_pctl","polenvt_pctl","popsens_pctl","lingisolation_pctl"),
                               f_min=c(0,0,0,0), f_max=c(100,100,100,100), f_cap=c(100,100,100,100),
                               f_binwidth=c(5,5,5,5), f_div=c(1,1,1,1), y_liml=c(0,0,0,0), y_limh=c(20,20,16,12),
                               f_xlab=c("Pollution burden - exposure (percentile)", "Pollution burden - environment (percentile)",
                                        "Sensitive population (percentile)", "Linguistic isolation (percentile)"),
                               f_cat=c("demo_ces_","demo_ces_","demo_ces_","demo_ces_")))

featscales <- featscales %>%
 mutate(feature = as.character(feature), f_xlab = as.character(f_xlab), f_cat = as.character(f_cat)) %>%
 mutate(span_SCE_MUD=NA, span_PGE_MUD=NA)
```

--------------------------------------------------------------------------------------------

LOESS PLOTS

--------------------------------------------------------------------------------------------


Calculating optimal span parameters for loess plots
--------------------------------------------------------------------------------------------

```{r}
for (i in 1:17){ #from 1 to 17
  df = rbind(select(PGE_ICAalldemo, c(cols, featscales[i,"feature"])), select(SCE_ICAalldemo, c(cols, featscales[i,"feature"]))) 
  df = df[which(!is.na(df[[featscales[i,"feature"]]])),]
  df$var_bin = as.numeric(as.character(cut(df[[featscales[i,"feature"]]], 
        breaks=seq(featscales[i,"f_min"], featscales[i,"f_max"], by=featscales[i,"f_binwidth"]), 
        labels=seq(featscales[i,"f_min"], featscales[i,"f_max"]-featscales[i,"f_binwidth"], by=featscales[i,"f_binwidth"]))))
  df$var_bin = ifelse(df$var_bin>featscales[i,"f_cap"], featscales[i,"f_cap"], df$var_bin)
  df$var_bin = ifelse(df[[featscales[i,"feature"]]]==featscales[i,"f_min"], featscales[i,"f_min"], df$var_bin)
  
df <- df %>% 
  na.omit() %>%
  mutate(tothh_Cpoly_int = round(tothh_Cpoly*1000000,0)) %>% group_by(var_bin, IOU) %>%
    summarise(MUD = wtd.quantile(MUD_pct, probs=0.5, weight=tothh_Cpoly_int, na.rm=TRUE, normwt=FALSE)[[1]], tothh_Cpoly = sum(tothh_Cpoly, na.rm=TRUE),
    .groups = "drop") %>%
  as.data.frame()

  for (j in c("PGE","SCE")){ df_IOU <- df %>%
    subset(IOU==j)
    lobj <- loess.as(df_IOU$var_bin, df_IOU[["MUD"]], weights=df_IOU$tothh_Cpoly, degree=2, criterion="gcv", plot=FALSE)
    featscales[[paste0("span_",j,"_","MUD")]][i] = lobj$pars$span
}}
rm(lobj, df_IOU)

ftsp <- featscales[,c("feature","f_cat","span_PGE_MUD","span_SCE_MUD")] %>%
  melt(id=c("feature","f_cat")) %>% 
  mutate(variable=as.character(variable),
         IOU=sapply(strsplit(variable, "_"), function(x) x[2])) %>% dplyr::rename("span"="value")
```
  
Calculating confidence intervals via bootstrapped loess
--------------------------------------------------------------------------------------------
  
```{r}
tic()
for (i in 1:17){ #from 1 to 17

df = rbind(select(PGE_ICAalldemo, c(cols, featscales[i,"feature"])), select(SCE_ICAalldemo, c(cols, featscales[i,"feature"]))) 
  df = df[which(!is.na(df[[featscales[i,"feature"]]])),]
  df$var_bin = as.numeric(as.character(cut(df[[featscales[i,"feature"]]], 
        breaks=seq(featscales[i,"f_min"], featscales[i,"f_max"], by=featscales[i,"f_binwidth"]), 
        labels=seq(featscales[i,"f_min"], featscales[i,"f_max"]-featscales[i,"f_binwidth"], by=featscales[i,"f_binwidth"]))))
  df$var_bin = ifelse(df$var_bin>featscales[i,"f_cap"], featscales[i,"f_cap"], df$var_bin)
  df$var_bin = ifelse(df[[featscales[i,"feature"]]]==featscales[i,"f_min"], featscales[i,"f_min"], df$var_bin)
  df <- df %>% na.omit() %>% 
    mutate(tothh_Cpoly_int = round(tothh_Cpoly*1000000,0))

#MEDIAN CALCULATION
df_ft <- df %>%
  group_by(var_bin, IOU) %>%
  summarise(
    MUD = wtd.quantile(MUD_pct, probs=0.5, weight=tothh_Cpoly_int, na.rm=TRUE, normwt=FALSE)[[1]],
    tothh_Cpoly = sum(tothh_Cpoly, na.rm=TRUE),
    .groups = "drop"
  ) %>%
  rename(wtdmed = MUD)

  #####

for (j in c("PGE","SCE")){
  
  df_n <- df[,c("IOU","var_bin",featscales[i,"feature"],"tothh_Cpoly","tothh_Cpoly_int",
              "MUD_pct")] %>% filter(IOU==j)

loessbt_MUD <- function(x, indices) { d <- x[indices,] 
  d <- d %>% nest(data = c(-var_bin)) %>% arrange(var_bin) %>% 
    mutate(MUD = unlist(map(data, 
                        ~wtd.quantile(.x$MUD_pct, probs=0.5, weight=.x$tothh_Cpoly_int, na.rm=TRUE, normwt=FALSE)[[1]])),
           tothh_Cpoly = unlist(map(data, ~sum(.x$tothh_Cpoly, na.rm=TRUE))))
  loess_fit <- loess(MUD~var_bin, d, weights=tothh_Cpoly, control=loess.control(surface="direct"),
                     span=filter(featscales, feature==featscales[i,"feature"])[[paste0("span_",j,"_MUD")]])
  predict(loess_fit, data.frame(var_bin=sort(unique(x$var_bin))), se=T)$fit}

tic()
bootres_MUD <- boot(data=df_n, statistic=loessbt_MUD, R=1000) #Change iteration number R
toc()

  #####

cidf <- data.frame(var_bin = sort(unique(df_n$var_bin))) %>% mutate(IOU=j) %>%
  mutate(MUD_lfit = bootres_MUD$t0)

for(ci in c(.10,.25,.50,.75,.80,.85,.90,.95,1)){
  cidf[[paste0("MUD_ci",ci*100,"l")]] <- apply(bootres_MUD$t, 2, function(x) quantile(x, (1-ci)/2))
  cidf[[paste0("MUD_ci",ci*100,"h")]] <- apply(bootres_MUD$t, 2, function(x) quantile(x, 1-(1-ci)/2))
  }

cidf <- cidf %>%
  mutate(across(-c(var_bin, IOU), as.character)) %>%
  melt(id=c("var_bin","IOU")) %>%
  mutate(variable=as.character(variable),
         ci=factor(sapply(strsplit(variable, "_"), function(x) x[2]), 
                   levels=c("lfit","ci10l","ci10h","ci25l","ci25h","ci50l","ci50h","ci75l","ci75h",
                            "ci80l","ci80h","ci85l","ci85h","ci90l","ci90h","ci95l","ci95h","ci100l","ci100h"))) %>%
         #dir=factor(sapply(strsplit(variable, "_"), function(x) x[3]), levels=c("l","h"))) %>%
  dcast(IOU+var_bin~ci, value.var="value")
  #dplyr::rename(lfit=value)

df_ft <- df_ft %>% merge(cidf, by=c("IOU","var_bin"), all.x=TRUE)
}
  
  df_ft <- df_ft %>%
    mutate(lfit = as.numeric(ifelse(!is.na(lfit.x),lfit.x,lfit.y))) %>%
    select(-c("lfit.x","lfit.y")) %>%
    
    mutate(
      ci10l = as.numeric(if_else(IOU == "PGE", ci10l.x, ci10l.y)),
      ci10h = as.numeric(if_else(IOU == "PGE", ci10h.x, ci10h.y)),
      ci25l = as.numeric(if_else(IOU == "PGE", ci25l.x, ci25l.y)),
      ci25h = as.numeric(if_else(IOU == "PGE", ci25h.x, ci25h.y)),
      ci50l = as.numeric(if_else(IOU == "PGE", ci50l.x, ci50l.y)),
      ci50h = as.numeric(if_else(IOU == "PGE", ci50h.x, ci50h.y)),
      ci75l = as.numeric(if_else(IOU == "PGE", ci75l.x, ci75l.y)),
      ci75h = as.numeric(if_else(IOU == "PGE", ci75h.x, ci75h.y)),
      ci80l = as.numeric(if_else(IOU == "PGE", ci80l.x, ci80l.y)),
      ci80h = as.numeric(if_else(IOU == "PGE", ci80h.x, ci80h.y)),
      ci85l = as.numeric(if_else(IOU == "PGE", ci85l.x, ci85l.y)),
      ci85h = as.numeric(if_else(IOU == "PGE", ci85h.x, ci85h.y)),
      ci90l = as.numeric(if_else(IOU == "PGE", ci90l.x, ci90l.y)),
      ci90h = as.numeric(if_else(IOU == "PGE", ci90h.x, ci90h.y)),
      ci95l = as.numeric(if_else(IOU == "PGE", ci95l.x, ci95l.y)),
      ci95h = as.numeric(if_else(IOU == "PGE", ci95h.x, ci95h.y)),
      ci100l = as.numeric(if_else(IOU == "PGE", ci100l.x, ci100l.y)),
      ci100h = as.numeric(if_else(IOU == "PGE", ci100h.x, ci100h.y))
    ) %>%
    # Select only the final columns you want to keep
    select(IOU, var_bin, wtdmed, tothh_Cpoly,
           starts_with("ci"), # This selects all columns that start with "ci"
           -matches("\\.x$|\\.y$"), lfit)


  write.csv(df_ft, file=paste0("figures_housing/lowessci/",featscales[i,"f_cat"],featscales[i,"feature"],"_lfit.csv"), row.names=FALSE)
}
rm(ci,cidf)
toc()
```  

Plotting results for all variables

```{r}
plotops = list(theme_light(), theme(legend.position="bottom"), 
               scale_color_gradientn(colors=sequential_hcl(7, palette="Inferno")[1:6], 
                                     values=c(2500,500,300,200,100,0)/2500, space="Lab", na.value="grey50", 
                                     guide=guide_colorbar(direction="horizontal", barwidth=10, barheight=0.5, nrow=2)))

plotlabs = c("Median of multi-unit dwellings proportion (%) per bin","Households (1000s)")

#https://stackoverflow.com/questions/38925604/setting-a-unique-span-parameter-for-each-geom-smooth-on-a-multi-facet-ggplot

for(i in 1:17){ #from 1 to 17

df_p <- read.csv(paste0("figures_housing/lowessci/", featscales[i, "f_cat"], featscales[i, "feature"], "_lfit.csv"),
                 header = TRUE, 
                 na.strings = "?", 
                 colClasses = c(rep("factor", 1), rep("numeric", 21))) %>%
  mutate(IOUDER = factor(ifelse(IOU == "PGE", "PG&E - Load", "SCE - Load"),
                          levels = c("PG&E - Load", "SCE - Load")))
                 
    ggplot(df_p, aes(x=var_bin/featscales[i,"f_div"], y=wtdmed*100, color=tothh_Cpoly/1000, weight=tothh_Cpoly)) + 
      theme_light() + theme(legend.position="bottom") + facet_wrap(~IOUDER, scales="free", nrow=2) +
    geom_ribbon(data=df_p, aes(x=var_bin/featscales[i,"f_div"], ymin=ci90l*100, ymax=ci90h*100), fill="lightsteelblue1", alpha=0.5, inherit.aes=FALSE) +
    geom_ribbon(data=df_p, aes(x=var_bin/featscales[i,"f_div"], ymin=ci50l*100, ymax=ci50h*100), fill="lightsteelblue2", alpha=0.5, inherit.aes=FALSE) +
    geom_smooth(data=filter(df_p, IOU=="SCE"), method='loess', formula=y~x, se=FALSE, linewidth=0.5,
                span=filter(featscales, feature==featscales[i,"feature"])$span_SCE_MUD) +
    geom_smooth(data=filter(df_p, IOU=="PGE"), method='loess', formula=y~x, se=FALSE, linewidth=0.5,
                span=filter(featscales, feature==featscales[i,"feature"])$span_PGE_MUD) +
    geom_point(size=1) + scale_color_gradientn(colors=sequential_hcl(7, palette="Inferno")[6:1], 
                                               space="Lab", na.value="grey50", 
                                               guide=guide_colorbar(direction="horizontal", barwidth=10, barheight=0.5, nrow=2)) +
    scale_y_continuous(breaks=scales::pretty_breaks(3)) + 
    labs(x=featscales[i,"f_xlab"], y=plotlabs[1], color=plotlabs[2], fill="Confidence intervals")
    ggsave(paste0(featscales[i,"f_cat"],featscales[i,"feature"],".png"), path="figures_housing/lowesscomb/", width=8, height=6.5)
}
```

Refining plots manually for key variables
--------------------------------------------------------------------------------------------

Lowess plots - race

```{r}
df_p <- read.csv(paste0("figures_housing/lowessci/",featscales[1,"f_cat"],featscales[1,"feature"],"_lfit.csv"), 
                 header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))) %>% mutate(feature="racediversity")

for (i in 2:5){
df_p <- rbind(df_p, 
              mutate(read.csv(paste0("figures_housing/lowessci/",featscales[i,"f_cat"],featscales[i,"feature"],"_lfit.csv"), 
                                    header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                           feature=featscales[i,"feature"]))
}

df_p <- df_p %>%
  mutate(feature = recode(factor(feature, levels=c("asian_pct","black_pct","latinx_pct","nlxwhite_pct","racediversity")), 
                          'asian_pct'="Asian", 'black_pct'="Black", 'latinx_pct'="Latinx", 
                          'nlxwhite_pct'="non-Latinx white", 'racediversity'="Race diversity"))

plotops <- list(theme_light(), facet_grid(IOU~., scales="fixed"),
  geom_ribbon(aes(ymin=ci90l*100, ymax=ci90h*100, fill=feature), alpha=0.3),
  geom_ribbon(aes(ymin=ci50l*100, ymax=ci50h*100, fill=feature), alpha=0.3),
  geom_line(aes(y=lfit*100, color=feature)),
  scale_x_continuous(breaks=seq(0,100,by=20)),
  scale_color_discrete_qualitative(palette="Dark3"), scale_fill_discrete_qualitative(palette="Dark3"),
  labs(x="Population identifying as racial/ethnic group (%)", y=plotlabs[1], fill="Racial/ethnic groups", color="Racial/ethnic groups", color="Racial/ethnic groups"))

a <- ggplot(filter(df_p), aes(x=var_bin*100, weight=tothh_Cpoly)) + plotops +
   scale_y_continuous(breaks=seq(0,100,20)) + coord_cartesian(ylim=c(0,100))

ggsave("demo_race_all.png", a, path="figures_housing/lowesscomb/", width=8, height=5.5)

print(a)
```


Plots B1/B2 - Income 

```{r}
df_p <- rbind(mutate(read.csv(paste0("figures_housing/lowessci/",featscales[6,"f_cat"],featscales[6,"feature"],"_lfit.csv"), 
                                    header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                           feature=featscales[6,"feature"]), 
              mutate(read.csv(paste0("figures_housing/lowessci/",featscales[7,"f_cat"],featscales[7,"feature"],"_lfit.csv"), 
                                    header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                           feature=featscales[7,"feature"])) %>%
  mutate(feature = ifelse(feature=="inc50kbelow_pct","<$50",">=$150k"))

plotops <- list(theme_light(), facet_grid(IOU~., scales="fixed"),
  geom_ribbon(aes(ymin=ci90l*100, ymax=ci90h*100, fill=feature), alpha=0.3),
  geom_ribbon(aes(ymin=ci50l*100, ymax=ci50h*100, fill=feature), alpha=0.3),
  geom_point(aes(y=wtdmed*100, alpha=tothh_Cpoly/1000, fill=feature, shape=feature), size=1, color="black"),
  geom_line(aes(y=lfit*100, color=feature)),
  scale_shape_manual(values=c(21,22)),
  scale_x_continuous(breaks=seq(0,100,by=20)),
  scale_color_discrete_qualitative(palette="Dark3"), scale_fill_discrete_qualitative(palette="Dark3"),
  labs(x="Households earning in income tier (%)", y=plotlabs[1], fill="Income tier", color="Income tier", shape="Income tier", alpha=expression("Households (x10"^"3)")),
  guides(fill = guide_legend(nrow = 1, byrow = TRUE), color = guide_legend(nrow = 1, byrow = TRUE), shape = guide_legend(nrow = 1, byrow = TRUE), alpha = guide_legend(nrow = 1, byrow = TRUE)),
  theme(legend.position="top", legend.box = "horizontal")
  )

b1 <- ggplot(filter(df_p), aes(x=var_bin*100, weight=tothh_Cpoly)) + plotops + 
  scale_y_continuous(breaks=seq(0,100,20)) + coord_cartesian(ylim=c(0,100))

print(b1)
ggsave("demo_inc_all.png", b1, path="figures_housing/lowesscomb/", width=8, height=5.5)


df_p <- mutate(read.csv(paste0("figures_housing/lowessci/",featscales[8,"f_cat"],featscales[8,"feature"],"_lfit.csv"),
                              header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                     feature=featscales[8,"feature"])

plotops <- list(theme_light(), facet_grid(IOU~., scales="fixed"),
  geom_ribbon(aes(ymin=ci90l*100, ymax=ci90h*100, fill=feature), alpha=0.3),
  geom_ribbon(aes(ymin=ci50l*100, ymax=ci50h*100, fill=feature), alpha=0.3),
  geom_point(aes(y=wtdmed*100, alpha=tothh_Cpoly/1000, fill=feature), shape=21, size=1, color="black"),
  geom_line(aes(y=lfit*100, color=feature)), scale_x_continuous(breaks=seq(0,250,by=50)),
  scale_fill_manual(values=c(qualitative_hcl(2,palette="Dark3")[2])),
  scale_color_manual(values=c(qualitative_hcl(2,palette="Dark3")[2])),
  labs(x="Median household income ($)", y=plotlabs[1], alpha=expression("Households (x10"^"3)")),
  guides(fill = "none", color = "none", alpha = guide_legend(nrow = 1, byrow = TRUE)),
  theme(legend.position="top", legend.box = "horizontal")
  )

b2 <- ggplot(filter(df_p), aes(x=var_bin/1000, weight=tothh_Cpoly)) + plotops

print(b2)

ggsave("demo_inc_medhhinc_2.png", b2, path="figures_housing/lowesscomb/", width=8, height=5.5)
```

Lowess plots - CalEnviroScreen

```{r}
df_p <- rbind(mutate(read.csv(paste0("figures_housing/lowessci/",featscales[14,"f_cat"],featscales[14,"feature"],"_lfit.csv"), 
                                    header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                           feature=featscales[14,"feature"]), 
              mutate(read.csv(paste0("figures_housing/lowessci/",featscales[15,"f_cat"],featscales[15,"feature"],"_lfit.csv"), 
                                    header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                           feature=featscales[15,"feature"])) %>%
  mutate(feature = ifelse(feature=="polenvt_pctl","Environment","Exposure"))

plotops <- list(theme_light(), facet_grid(IOU~., scales="fixed"),
  geom_ribbon(aes(ymin=ci90l*100, ymax=ci90h*100, fill=feature), alpha=0.3),
  geom_ribbon(aes(ymin=ci50l*100, ymax=ci50h*100, fill=feature), alpha=0.3),
  geom_point(aes(y=wtdmed*100, alpha=tothh_Cpoly/1000, fill=feature, shape=feature), size=1, color="black"),
  geom_line(aes(y=lfit*100, color=feature)),
  scale_shape_manual(values=c(21,22)),
  scale_x_continuous(breaks=seq(0,100,by=20)),
  scale_color_discrete_qualitative(palette="Dark3"), scale_fill_discrete_qualitative(palette="Dark3"),
  labs(x="CalEnviroScreen pollution indicator (percentile)", y=plotlabs[1], fill="Pollution burden", color="Pollution burden", shape="Pollution burden", alpha=expression("Households (x10"^"3)")),
  guides(fill = guide_legend(nrow = 1, byrow = TRUE), color = guide_legend(nrow = 1, byrow = TRUE), shape = guide_legend(nrow = 1, byrow = TRUE), alpha = guide_legend(nrow = 1, byrow = TRUE)),
  theme(legend.position="top", legend.box = "horizontal")
  )

c1 <- ggplot(filter(df_p), aes(x=var_bin, weight=tothh_Cpoly)) + plotops 

print(c1)

ggsave("demo_ces_all_pollution.png", c1, path="figures_housing/lowesscomb/", width=8, height=5.5)


df_p <- rbind(mutate(read.csv(paste0("figures_housing/lowessci/",featscales[16,"f_cat"],featscales[16,"feature"],"_lfit.csv"), 
                                    header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                           feature=featscales[16,"feature"]),
              mutate(read.csv(paste0("figures_housing/lowessci/",featscales[17,"f_cat"],featscales[17,"feature"],"_lfit.csv"), 
                                    header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                           feature=featscales[17,"feature"])) %>%
  mutate(feature = ifelse(feature=="popsens_pctl","Sensitive populations","Ling. isolation"))

plotops <- list(theme_light(), facet_grid(IOU~., scales="fixed"),
  geom_ribbon(aes(ymin=ci90l*100, ymax=ci90h*100, fill=feature), alpha=0.3),
  geom_ribbon(aes(ymin=ci50l*100, ymax=ci50h*100, fill=feature), alpha=0.3),
  geom_point(aes(y=wtdmed*100, alpha=tothh_Cpoly/1000, fill=feature, shape=feature), size=1, color="black"),
  geom_line(aes(y=lfit*100, color=feature)),
  scale_shape_manual(values=c(21,22)),
  scale_x_continuous(breaks=seq(0,100,by=20)),
  scale_color_discrete_qualitative(palette="Dark3"), scale_fill_discrete_qualitative(palette="Dark3"),
  labs(x="CalEnviroScreen population indicator (percentile)", y=plotlabs[1], fill="Population indicator", color="Population indicator", shape="Population indicator", alpha=expression("Households (x10"^"3)")),
  guides(fill = guide_legend(nrow = 1, byrow = TRUE), color = guide_legend(nrow = 1, byrow = TRUE), shape = guide_legend(nrow = 1, byrow = TRUE), alpha = guide_legend(nrow = 1, byrow = TRUE)),
  theme(legend.position="top", legend.box = "horizontal")
  )

c2 <- ggplot(filter(df_p), aes(x=var_bin, weight=tothh_Cpoly)) + plotops

print(c2)

ggsave("demo_ces_all_population.png", c2, path="figures_housing/lowesscomb/", width=8, height=5.5)
```

Lowess plots - housing types

```{r}
df_p <- mutate(read.csv(paste0("figures_housing/lowessci/",featscales[9,"f_cat"],featscales[9,"feature"],"_lfit.csv"), 
                                    header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                           feature=featscales[9,"feature"])

plotops <- list(theme_light(), facet_grid(IOU~., scales="fixed"),
  geom_ribbon(aes(ymin=ci90l*100, ymax=ci90h*100, fill=feature), alpha=0.3),
  geom_ribbon(aes(ymin=ci50l*100, ymax=ci50h*100, fill=feature), alpha=0.3),
  geom_point(aes(y=wtdmed*100, alpha=tothh_Cpoly/1000, fill=feature, shape=feature), size=1, color="black"),
  geom_line(aes(y=lfit*100, color=feature)),
  scale_shape_manual(values=c(21,22)),
  scale_x_continuous(breaks=seq(0,100,by=20)),
  scale_color_discrete_qualitative(palette="Dark3"), scale_fill_discrete_qualitative(palette="Dark3"),
  labs(x="Owner-occupied households (%)", y=plotlabs[1], fill="Feature", color="Feature", shape="Feature", alpha=expression("Households (x10"^"3)")),
  guides(fill = "none", color = "none", shape="none", alpha = guide_legend(nrow = 1, byrow = TRUE)),
  theme(legend.position="top", legend.box = "horizontal")
  )

d1 <- ggplot(filter(df_p), aes(x=var_bin*100, weight=tothh_Cpoly)) + plotops 

print(d1)
ggsave("demo_hs_all.png", d1, path="figures_housing/lowesscomb/", width=8, height=5.5)

df_p <- mutate(read.csv(paste0("figures_housing/lowessci/",featscales[10,"f_cat"],featscales[10,"feature"],"_lfit.csv"), 
                              header=T, na.strings="?", colClasses=c(rep("factor",1),rep("numeric",22))),
                     feature=featscales[10,"feature"])

plotops <- list(theme_light(), facet_grid(IOU~., scales="fixed"),
  geom_ribbon(aes(ymin=ci90l*100, ymax=ci90h*100, fill=feature), alpha=0.3),
  geom_ribbon(aes(ymin=ci50l*100, ymax=ci50h*100, fill=feature), alpha=0.3),
  geom_point(aes(y=wtdmed*100, alpha=tothh_Cpoly/1000, fill=feature), shape=21, size=1, color="black"),
  geom_line(aes(y=lfit*100, color=feature)), scale_x_continuous(breaks=seq(1940,2010,by=20)),
  scale_fill_manual(values=c(qualitative_hcl(2,palette="Dark3")[2])), 
  scale_color_manual(values=c(qualitative_hcl(2,palette="Dark3")[2])), 
  labs(x="Median year built", y=plotlabs[1], alpha=expression("Households (x10"^"3)")),
  guides(fill = "none", color = "none", shape="none", alpha = guide_legend(nrow = 1, byrow = TRUE)),
  theme(legend.position="top", legend.box = "horizontal")
  )

d2 <- ggplot(filter(df_p), aes(x=var_bin, weight=tothh_Cpoly)) + plotops 

print(d2)
ggsave("demo_hs_medyrbuilt_2.png", d2, path="figures_housing/lowesscomb/", width=8, height=5.5)
```

Plotting Figure A.9

```{r}
plot_grid(b1, b2, c2, d1, nrow=2, ncol=2, scale=0.95, labels=c('a','b','c','d'), label_size=15)

ggsave("figures_housing/lowesscomb/all_mud_demo.png", width=16, height=10)
```

